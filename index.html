<!DOCTYPE html>
<html>
    <head>
        <title>Tamagotchi Pet</title>
        <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
        <!-- App.js stylesheet -->
        <link rel="stylesheet" href="http://cdn.kik.com/app/1/default.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <!-- My Javascript -->
        <script type="text/javascript" src="script.js"></script>
        <script type="text/javascript" src="petengine.js"></script>
        <!-- Needed for Kik card functionality -->
        <script src="http://cdn.kik.com/kik/1.0.3/kik.js"></script>
        <meta name="description" content="A Tamagotchi pet written in HTML5. Optimized for Kik Messenger.">
        <link rel="kik-icon" href="images/smileyface.png">
        <link rel="canonical" href="http://example.com/prod/">
    </head>
    <body id="thebody" onmousedown="setClick(true)" onmouseup="setClick(false)" ontouchstart="setClick(true)" ontouchend="setClick(false)" ontouchmove="scratchPet(event)">
        <!-- F_C stables -->
        <div class="app-page" data-page="stables">
            <div class="app-topbar">
                <table><tr>
                    <td class="topbar-icon"><img id="back-image-stables" class="topbar-image" src="images/backArrow.png"></img></td>
                    <td><div class="app-title">Stables</div></td>
                    <td style="position: absolute; right: 50px;" class="topbar-icon"><img id="friends-image-stables" class="topbar-image" src="images/friendIconWhite.png"></img></td>
                </tr></table>
            </div>
            <div id="stables-pets">
                <div id="pet-display-1" class="pet-display">
                </div>
                <div id="pet-display-new" class="pet-display">
                    <div id="add-pet" style="text-shadow: 0px 0px 10px white;">+</div>
                </div>
            </div>
        </div>
        <!-- F_C creator -->
        <div class="app-page" data-page="creator">
            <div class="app-topbar">
                <div class="app-title">Build a Pet</div>
            </div>
            <div class="centered-div">
                <br/>
                <div>Choose some basic options to customize your pet.</div>
                <span id="error-message" style="color: red; font-weight: bold"></span>
                <br/>
                <table>
                    <tr>
                        <td>Pet Name:</td>
                        <td><input type="text" placeholder="Your pet's name" class="app-input" id="pet-name"></input></td>
                    </tr>
                </table>
                <script type="text/javascript">
                    function create() {
                        name = EbyID("pet-name").value;
                        if(name == "" || name == null) {
                            error("Please enter a name.");
                            return;
                        } else if(!(/^[a-z0-9]*$/i.test(name))) {
                            error("Only alphanumeric names. No spaces.");
                            return;
                        }
                        /*localStorage.removeItem("pet");
                        pet = [
                            {"Health": 30},
                            {"Hunger": 50},
                            {"Happiness": 50},
                            {"Weight": 50},
                            {"Age": 0}
                        ];
                        alert(pet);
                        localStorage.setItem("pet", pet);*/
                        localStorage.removeItem("petHealth");
                        localStorage.setItem("petHealth", 100);
                        localStorage.removeItem("petHunger");
                        localStorage.setItem("petHunger", 100);
                        localStorage.removeItem("petHappiness");
                        localStorage.setItem("petHappiness", 100);
                        localStorage.removeItem("petWeight");
                        localStorage.setItem("petWeight", 50);
                        localStorage.removeItem("petAge");
                        localStorage.setItem("petAge", 0);
                        localStorage.removeItem("petBirthday");
                        localStorage.setItem("petBirthday", new Date());

                        localStorage.removeItem("petname");
                        localStorage.setItem("petname", name);
                        localStorage.removeItem("created");
                        localStorage.setItem("created", true);

                        loadPage("Pet");
                    }
                </script>
                <table><tr>
                    <td><div id="createButton" class="app-button">Create</div></td>
                    <td style="padding-left: 20px;"><div id="cancel-create" class="app-button">Cancel</div></td>
                </tr></table>
            </div>
        </div>
        <div class="app-page" data-page="Pet">
            <canvas width="100" height="100" style="position: absolute; left: 0px; top: 0px;" id="pet-canvas">
            </canvas>
            <div class="app-topbar">
                <table><tr>
                    <td class="topbar-icon"><img id="back-image-pet" class="topbar-image" src="images/backArrow.png"></img></td>
                    <td><div class="app-title">Pet</div></td>
                    <td style="position: absolute; right: 100px;" class="topbar-icon"><img id="friends-image-pet" class="topbar-image" src="images/friendIconWhite.png"></img></td>
                    <td style="position: absolute; right: 50px;" class="topbar-icon" style="padding-top: 0px;"><img id="stables-image-pet" class="topbar-image" src="images/stablesIconWhite.png"></img></td>
                </tr></table>
            </div>
            <div id="main-pet-div">
                <span id="error-message-pet" style="color: red; font-weight: bold;"></span>
                <br/>
                <br/>
                <center id="pet-wrapper">
                    <div ><div id="pet-image" class="pet-image happy" ontouchmove="scratchPet(event)"></div></div>
                    <span id="petname"></span>
                </center>
                <div id="other-petpage-stuff">
                    <table id="pet-stats">
                        <tr>
                            <td>Health: </td>
                            <td><div class="progressbar-back"><div class="progressbar-front" id="health-bar"></div></div></td>
                        </tr>
                        <tr>
                            <td>Hunger: </td>
                            <td><div class="progressbar-back"><div class="progressbar-front" id="hunger-bar"></div></div></td>
                        </tr>
                        <tr>
                            <td>Happiness: </td>
                            <td><div class="progressbar-back"><div class="progressbar-front" id="happiness-bar"></div></div></td>
                        </tr>
                        <tr>
                            <td>Weight: </td>
                            <td><div class="progressbar-back"><div class="progressbar-front" id="weight-bar"></div></div></td>
                        </tr>
                        <tr>
                            <td>Age: </td>
                            <td><div id="pet-age"></div></td>
                        </tr>
                    </table>
                    <br/>
                    <div class="normal-margin">
                        <div class="app-button" id="dance-button">Dance</div>
                        <div class="app-button" id="jump-button">Exercise</div>
                    </div>
                    <div class="app-section" id="food-section">
                        <center>Feed your pet</center>
                    </div>
                </div>
            </div>
        </div>
        <!-- F_C exercise page -->
        <div class="app-page" data-page="exercise-page">
             <div class="app-topbar">
                <table><tr>
                    <td class="topbar-icon"><img id="back-image-exercise" class="topbar-image" src="images/backArrow.png"></img></td>
                    <td><div class="app-title" id="exercise-title">Pet</div></td>                    
                </tr></table>
            </div>
            <center id="pet-wrapper">
                <div id="pet-wrapper-exercise"><div id="pet-image-exercise" class="pet-image happy"></div></div>
                <span id="petname"></span>
            </center>
            <div id="ground-exercise">
            </div>
        </div>
        <!-- I removed this, replace it if something doesn't work right: </div> -->
        <!-- App.js -->
        <script src="http://cdn.kik.com/app/1/app.js"></script>
        <!-- JQuery -->
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
        <!-- My code -->
        <script type="text/javascript">
            clicked = false;
            //Define food items
            foodItems = new Object;
            foodItemList = new Array();


            foodItems.chocolateBar = new Object;
            foodItems.chocolateBar.happiness = 5;
            foodItems.chocolateBar.weight = 15;
            foodItems.chocolateBar.hunger = 8;
            foodItems.chocolateBar.image = "images/chocolateBar.png";
            foodItems.chocolateBar.displayName = "Chocolate Bar";
            foodItems.chocolateBar.name = "chocolateBar";
            foodItemList[0] = foodItems.chocolateBar;

            foodItems.steak = new Object;
            foodItems.steak.happiness = 0;
            foodItems.steak.weight = 4;
            foodItems.steak.hunger = 15;
            foodItems.steak.image = "images/steak.png";
            foodItems.steak.displayName = "Steak";
            foodItems.steak.name = "steak";
            foodItemList[1] = foodItems.steak;

            particleList = new Array();

            petDisplayNumber = 0;
            function populateFoodImage(item, container) {
                if(container == null) {
                    container = EbyID("food-section");
                }
                html  = '<img class="food-image" src="';
                html += item.image;
                html += '" id="food-item-' + item.name;
                html += '" onclick="selectFoodItem(\'' + item.name + '\')"></img>';
                container.innerHTML += html;
            }
            foodTimeout = 0;
            //Note that particles only work in the area above the bars, etc. This is to fix issue #1. See the docs for this page for more info.
            function Particle(color, size, gravity, x, y) {
                this.size = size;
                this.color = color;
                this.gravity = gravity;
                this.left = x;
                this.top = y;
                this.ticksLived = 0;
                //Actually create the element
                this.draw = function() {
                    canvas = EbyID("pet-canvas");
                    context = canvas.getContext("2d");
                    context.fillStyle = this.color;
                    context.fillRect(this.left, this.top, this.size, size);
                };
                this.update = function() {
                    this.top += this.gravity;
                    this.draw();
                    this.ticksLived++;
                    if(this.ticksLived > 20) {
                        index = particleList.indexOf(this);
                        particleList.splice(index, 1);
                    }
                };
                particleList.push(this);
            }
            //Occurs when a food item is clicked on the page.
            function selectFoodItem(name) {
                if(EbyID("food-item-" + name).getAttribute("style") == "" || EbyID("food-item-" + name).getAttribute("style") == null) {
                    if(foodTimeout <= 0) {
                        EbyID("food-item-" + name).setAttribute("style", "background-color: black;");
                    } else {
                        EbyID("food-item-" + name).setAttribute("style", "background-color: red;");
                        setPetError("Please wait " + foodTimeout + " seconds.");
                        setTimeout(function() {
                            EbyID("food-item-" + name).setAttribute("style", "");
                        }, 100);
                        return;
                    }
                    foodItem = null;
                    for(i = 0; i < foodItemList.length; i++) {
                        if(foodItemList[i].name == name) {
                            foodItem = foodItemList[i];
                        }
                    }
                    feedPet(foodItem);
                    foodTimeout = 10;
                    setTimeout(function() {
                        EbyID("food-item-" + name).setAttribute("style", "");
                    }, 100);
                }
            }
            //F_C feedPet
            function feedPet(item) {
                //throw ((getItem("petWeight") / 1) + item.weight);
                if((getItem("petWeight") / 1) + item.weight > 100) {
                    localStorage.setItem("petWeight", 100);
                    addItem("petHealth", -(Math.floor(item.weight / 2)));
                } else {
                    addItem("petWeight", item.weight);
                    addItem("petHealth", -(Math.floor(item.weight / 2)));
                }
                if((getItem("petHunger") / 1) + item.hunger > 100) {
                    localStorage.setItem("petHunger", 100);
                } else {
                    addItem("petHunger", item.hunger);
                }
                if((getItem("petHappiness") / 1) + item.happiness > 100) {
                    localStorage.setItem("petHappiness", 100);
                } else {
                    addItem("petHappiness", item.happiness);
                }
                updateRendering();
            }
            errorWillBeCleared = false;
            function setPetError(error) {
                EbyID("error-message-pet").innerHTML = error;
                errorWillBeCleared = true;
                setTimeout(function() {
                    //Clear it after some time
                    if(errorWillBeCleared) {
                        EbyID("error-message-pet").innerHTML = "";
                        errorWillBeCleared = false;
                    } else {
                        return;
                    }
                }, 2000);
            }
            //Populate the food images
            populateFoodImage(foodItems.chocolateBar);
            populateFoodImage(foodItems.steak);



            //Gets the class corresponding to the happiness "happiness" and health "health". Note that health is used just for the dead face.
            function getHappiness(happiness, health) {
                if(happiness == null) {
                    happiness = localStorage.getItem("petHappiness");
                }
                if(health == null) {
                    health = localStorage.getItem("petHealth");
                }
                if(health < 5) {
                    return "dead";
                }
                if(happiness < 33) {
                    return "unhappy"
                }
                if(happiness < 66) {
                    return "undecided"
                }
                return "happy";
            }
            jumpMomentum = 0;
            jumpY = 100;
            function doJump() {
                for(i = 0; i < 300; i++) {
                    setTimeout(jumpOnce, 200 + (i * 20));
                }
                //EbyID("petname").innerHTML = "hi";
            }
            function jumpOnce() {
                //EbyID("petname").innerHTML = "hi2";
                //EbyID("petname").innerHTML = jumpY;
                jumpMomentum++;
                jumpY += jumpMomentum;
                if(jumpY >= 300) {
                    jumpMomentum = -(Math.floor(Math.random() * 5) + 15);
                }
                EbyID("pet-wrapper-exercise").setAttribute("style", "padding-top: " + jumpY + "px;");
                EbyID("ground-exercise").setAttribute("style", "margin-top: " + (300 - jumpY) + "px;");
            }
            function doDance() {
                EbyID("other-petpage-stuff").setAttribute("style", "visibility: hidden;");
                dance(EbyID("pet-wrapper"));
                setTimeout(function() {
                    EbyID("other-petpage-stuff").setAttribute("style", "");
                }, 241 * 20);
            }
            function creatorLater() {
                loadPage("creator");
            }
            function populatePetDisplay(display, name, happiness, health) {
                if(health == null) {
                    health = localStorage.getItem("petHealth");
                }
                if(happiness == null) {
                    happiness = localStorage.getItem("petHappiness");
                }
                s =  '<table><tr>';
                s += '    <td class="pet-display-item"><div class="pet-image ' + getHappiness(happiness, health) + '"></div></td>\n'
                s += '    <td class="pet-display-item"><div class="pet-display-name title">' + name + '</div></td>';
                s += '</tr></table>';
                display.innerHTML = s;
            }
            //Happens slowly
            function updateRendering() {
                setTimeout(updateRendering, 100);
            }
            setTimeout(renderingTick, 50);
            function resizeCanvas() {
                canvas = EbyID("pet-canvas");
                canvas.width = window.innerWidth;
                //To fix issue #1, this has been changed from the following line to how it is now:
                //canvas.height = window.innerHeight;
                canvas.height = 325;
            }
            function tick() {
                //alert(document.getElementById("health-bar"));
                //alert(App.getStack()[App.getStack().length - 1]);
                if(foodTimeout > 0) {
                    foodTimeout--;
                }
                changeThePet();
                setTimeout(tick, 1000);
            }
            setTimeout(tick, 1000);
            function renderingTick() {
                setTimeout(renderingTick, 50);
                //Particles
                canvas = EbyID("pet-canvas");
                context = canvas.getContext("2d");
                context.clearRect("0", "0", "1920", "1080"); //1920X1080 is overkill, but it won't be in the future :)
                for(i = 0; i < particleList.length; i++) {
                    particleList[i].update();
                }
                //Updating the pet page
                if(getPageName() == "Pet") {
                    updateProgressBar(document.getElementById("health-bar"), localStorage.getItem("petHealth"));
                    updateProgressBar(document.getElementById("hunger-bar"), localStorage.getItem("petHunger"));
                    updateProgressBar(document.getElementById("happiness-bar"), localStorage.getItem("petHappiness"));
                    updateProgressBar(document.getElementById("weight-bar"), localStorage.getItem("petWeight"), "black");
                    EbyID("pet-age").innerHTML = localStorage.getItem("petAge");//Math.floor((new Date().getTime() - localStorage.getItem("petBirthday").getTime()) / 60) + " minutes";
                    EbyID("pet-image").setAttribute("class", "pet-image " + getHappiness());
                }
                //Updating the exercise page
                if(getPageName() == "exercise-page") {
                    EbyID("pet-image-exercise").setAttribute("class", "pet-image " + getHappiness());
                }
            };
            setTimeout(renderingTick, 50);
            function setClick(value) {
                clicked = value;
            }
            petScratches = 0;
            function scratchPet(evt) {
                petScratches++;
                if(petScratches % 6 == 0) {
                    touch = evt.changedTouches[0];
                    boundingRect = EbyID("pet-image").getBoundingClientRect();
                    if((touch.clientX - boundingRect.left < 100 && touch.clientX - boundingRect.left > 0) &&
                        (touch.clientY - boundingRect.top < 100 && touch.clientY - boundingRect.top > 0)) {
                        p = new Particle("#464646", 5, 1, touch.clientX, touch.clientY);
                        if(petScratches % 16 == 0 && getItem("petHappiness") / 1 < 100) {
                            addItem("petHappiness", 1);
                        }
                    }
                }
            }
            App.populator("creator", function(page) {
                $(page)
                    .find("#createButton")
                    .on("click", function() {
                        create();
                    })
                $(page)
                    .on("appShow", function() {
                        if(localStorage.getItem("created") == null || localStorage.getItem("created") == false || localStorage.getItem("created") == "false") {
                            EbyID("cancel-create").style.visibility = "hidden";
                        } else {
                            EbyID("cancel-create").style.visibility = "visible";
                        }
                    })
                    $(page)
                    .find("#cancel-create")
                    .on("click", function() {
                        App.back(function() {
                            //Do nothing
                        });
                    });
                });
            App.populator("main", function(page) {
                //alert(document.getElementById("health-bar"));
            })
            //F_C stables populator
            App.populator("stables", function(page) {
                $(page)
                .on("appShow", function() {
                    populatePetDisplay(EbyID("pet-display-1"), localStorage.getItem("petname"));
                });
                $(page)
                    .find("#pet-display-1")
                    .on("click", function() {
                        loadPage("Pet");
                    });
                $(page)
                    .find("#add-pet")
                    .on("click", function() {
                        EbyID("add-pet").setAttribute("style", "text-shadow: 0px 0px 20px black;");
                        setTimeout(creatorLater, 125);
                    });
                $(page)
                    .find("#back-image-stables")
                    .on("click", function() {
                        App.back(function() {
                            //Do nothing
                        });
                    });
                $(page)
                    .on("appShow", function() {
                        EbyID("add-pet").setAttribute("style", "text-shadow: 0px 0px 10px white;");
                    });
            });
            App.populator("Pet", function(page) {
                $(page)
                    .on("appShow", function() {
                        EbyID("petname").innerHTML = localStorage.getItem("petname");
                        window.addEventListener("resize", resizeCanvas, false);
                        resizeCanvas();
                        //Note: For circle on canvas,
                        //context.arc(xpos, ypos, radius, 0, 2 * Math.PI)
                    })
                $(page)
                    .find("#stables-image-pet")
                    .on("click", function() {
                        loadPage("stables");
                    })
                $(page)
                    .find("#back-image-pet")
                    .on("click", function() {
                        App.back(function() {
                            //Do nothing
                        });
                    });
                $(page)
                    .find("#dance-button")
                    .on("click", function() {
                        doDance();
                    });
                $(page)
                    .find("#jump-button")
                    .on("click", function() {
                        if(foodTimeout <= 0) {
                            foodTimeout = 15;
                            loadPage("exercise-page");
                        } else {
                            setPetError("Please wait " + foodTimeout + " seconds.");
                        }
                    });
            });
            App.populator("exercise-page", function(page) {
                $(page)
                    .find("#back-image-exercise")
                    .on("click", function() {
                        App.back(function() {
                            //Do nothing
                        });
                    });
                doJump();
                setTimeout(function() {
                    addItem("petWeight", -10);
                    addItem("petHunger", -8);
                    App.back(function() {
                        //Do nothing
                    });
                }, 6100);
                EbyID("petname").innerHTML = localStorage.getItem("petname");
            });
            if(localStorage.getItem("created") == null) {
                localStorage.setItem("created", false)
            }
            if(localStorage.getItem("created") == true || localStorage.getItem("created") == "true") {
                loadPage("Pet");
            } else {
                loadPage("creator");
            }
        </script>
        <!-- F_C IOS styles -->
        <!-- Special stylesheet for IOS.
             Note that the stylesheet will be declared at the end of the body. If there's any problems, that's why. -->
        <script type="text/javascript">
            theBody = EbyID("thebody");
            if(theBody.getAttribute("class").indexOf("ios") != -1) {
                document.write('<link rel="stylesheet" type="text/css" href="stylesheet_ios.css"/>\n');
                all = document.getElementsByTagName("*");
                for (i = 0, max = all.length; i < max; i++) {
                    if(all[i].getAttribute("class") != null) {
                        all[i].setAttribute("class", all[i].getAttribute("class") + " ios");
                    }
                }
            }
        </script>
    </body>
</html>
